/*
Copyright (c) 2013, Groupon, Inc.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

Redistributions of source code must retain the above copyright notice,
this list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.

Neither the name of GROUPON nor the names of its contributors may be
used to endorse or promote products derived from this software without
specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

package com.groupon.nakala.db;

import com.groupon.nakala.core.Analyzable;
import com.groupon.nakala.core.CategorizedTextContent;
import com.groupon.nakala.core.Id;
import com.groupon.util.io.IoUtil;
import junit.framework.TestCase;
import org.junit.Test;

/**
 * @author npendar@groupon.com
 */
public class JsonCategorizedTextReaderTest extends TestCase {

    private static final String json =
            "{ \"_id\" : \"4f91fd68c58a968724000001\", \"title\" : \"(K)new\", \"source\" : null, \"source_id\" : \"http://www.opentable.com/knew?scpref=106\", \"reviews\" : [ { \"quote\" : null, \"rating\" : 0.8, \"content\" : \"I really liked the vibe and mood at (K)new. It's a family owned and operated restaurant, and everyone is really working hard. Our Open Table Reservation was seen, but they sat us right away anyway. The food was great, very tasty, good portions (not too little/too much). The only downside is that we waited 2-plus hours for our food and missed our movie. They apologized repeatedly, but sorry loses its meaning after awhile. They need more help, or to refuse big groups on busy Saturdays. I would give it another try though, as the food was great and they were very nice.\", \"date\" : \"Date( 1586761200000 )\" }, { \"quote\" : null, \"rating\" : 0.6, \"content\" : \"The food was great, I enjoyed everything we had. I felt bad because they seemed to be understaffed and the waitress was doing her best but our dinner took 3 1/2 hours!\", \"date\" : \"Date( 1586761200000 )\" }, { \"quote\" : null, \"rating\" : 0.8, \"content\" : \"The food was so good I wished there were more tables in there had a dead feeling to it, more people need to know about this place and go there!\", \"date\" : \"Date( 1584860400000 )\" }, { \"quote\" : null, \"rating\" : 0.8, \"content\" : \"Menu has all of the specials from Think. Well executed preparation, pork entree was excellent. Deserts outstanding. Definitely worth a visit. Note that the chef has just returned to work after some serious medical issues.\", \"date\" : \"Date( 1585378800000 )\" }, { \"quote\" : null, \"rating\" : 1, \"content\" : \"I guess this was a rare occasion but there was no one in the place but us. Which was perfect for me because it was my birthday. The server was very attentive and although they did not have everything on the menu, they di have what I wanted the Rack of lamb. The lamb was absolutely fabulous. Everything was prepared as if it was seasoned with a little bit of love. and the dessert was also amazing. This is definitely a place that I will come back to.\", \"date\" : \"Date( 1584255600000 )\" }, { \"quote\" : null, \"rating\" : 0.2, \"content\" : \"Overall, food was very indifferent, staff kind of different.\", \"date\" : \"Date( 1583823600000 )\" }, { \"quote\" : null, \"rating\" : 0.8, \"content\" : \"A bit printStream of the way, but well worth it! The food is very good. More people should seek it printStream.\", \"date\" : \"Date( 1583481600000 )\" }, { \"quote\" : null, \"rating\" : 1, \"content\" : \"Excellent prie fixe meal. Love the BYO. Had great time with friends.\", \"date\" : \"Date( 1583568000000 )\" }, { \"quote\" : null, \"rating\" : 0.2, \"content\" : \"The food is very solid here, but there is absolutely no reason to subject yourself to k(new)'s service issues. On a Saturday night there was only one waitress and not a single table turned over all night. Our dinner took almost 4 hours -- with more than a one-hour gap between the salad and entree courses. No apologies from the sole waitress who said our dinners were \\\"fired up\\\" the moment they cleared the salad plates (which of course sat at our table empty for more than 30 minutes before they were cleared). At one point, over a 30-minute period we asked 5 times if our waitress could stop by our table. I noticed a man at the table next to us kept getting up and seeking printStream a staff person any time he needed something because service was so a\", \"date\" : \"Date( 1583222400000 )\" }, { \"quote\" : null, \"rating\" : 1, \"content\" : \"This is by far my favorite restaurant in the city (and I can say that even having season tickets to Next.) The food is phenomenal in taste, preparation and they never get it wrong. We celebrate every single special occassion here and then the random days in between because there is no other place in the city where you can get such wonderful food and byo at the same time. The waitress is the nicest, most personable and knowledgeable waitress I've ever met. She makes our experience that much more enjoyable and we look forward to seeing her every time we go. I highly recommend this place to everyone I meet!\", \"date\" : \"Date( 1580544000000 )\" } ], \"rating\" : 0, \"food_rating\" : 0.78, \"atmosphere_rating\" : 0.6799999999999999, \"service_rating\" : 0.6799999999999999, \"website\" : \"http://knewrestaurant.com\", \"cuisine\" : \"Contemporary American, Fusion / Eclectic\", \"payment\" : \"Diners Club, Discover, MasterCard, Visa\", \"features\" : \"Banquet/Private Rooms, BYO Liquor, Chef's Table, Farm to Table, Non-Smoking Restaurant, Patio/Outdoor Dining, Personal wines welcome, Private Room, Takeout, Wheelchair Access\", \"hours\" : \"Dinner: Monday - Thursday: 5:00pm - 10:00pm, Friday & Saturday: 5:00pm - 11:00pm\", \"parking\" : \"\", \"desc\" : \"Chef Omar Rodriguez have created a space that is warm, simple and modern. They have created a space not to distract from Rodriguez\\\"s fusion of seasonal ingredients and global creations.\\r\\nLiving his passion for food and working in some of Chicago's finest kitchens, Chef Rodriguez is meeting his… patrons' expectations for excellent cuisine. He continues to please with creativity and passion.\\r\\nJoin him for Chicago's only BYOB Chef's Table, where Chef Rodriguez will personally serve every course.\\r\\n\\r\\n\\r\\n\\r\\n\\r\\n(K)new does not require that infants or small children are included in party size for online reservations. Continued\", \"attire\" : \"Smart Casual\", \"dining_style\" : \"Casual Elegant\", \"price\" : \"$30 and under\", \"email\" : \"omarthechef@sbcglobal.net\" }\n" +
                    "{ \"_id\" : \"4f91fd68c58a968724000002\", \"title\" : \"2nd Street Bistro - Highland Park\", \"source\" : null, \"source_id\" : \"http://www.opentable.com/2nd-street-bistro-highland-park?scpref=106\", \"reviews\" : [ { \"quote\" : null, \"rating\" : 0.8, \"content\" : \"Service was outstanding - server knew everything on the menu, exactly how it is prepared and provided us with some great recommendations for our 1st time being there. Love the fact that it was BYOB - brought in a very nice bottle of wine and they not only opened it but provided the glasses. Food was incredible - my steak was perfectly cooked and full of flavor! My only issues are that for the quality of food and service, the restaurant itself looks a little cheap and the noise level is extreme. Definitely will go back for the food & service but would not be a place to bring a date for a romantic evening.\", \"date\" : \"Date( 1586847600000 )\" }, { \"quote\" : null, \"rating\" : 0.8, \"content\" : \"We actually dined at the Italian side of this location called 2nd Street Enteoco. It is in the same location as the Bistro but a separate adjoining rooom. It was great and we will definitely go back.\", \"date\" : \"Date( 1586847600000 )\" }, { \"quote\" : null, \"rating\" : 1, \"content\" : \"Michael Gottlieb has a very creative menu with sustainable ingredients. When time permits, he has come to our table to discuss his techniques and inspirations. The BYOB feature allows diners to bring a favorite bottle to accompany the entree' of choice at big savings over typical restaurant prices. Servers are able to describe all of the items on the menu in detail and make recommendations based on diner preferences. All in all, this is a neighborhood gem that will grace Highland Park patrons for years to come.\", \"date\" : \"Date( 1585724400000 )\" }, { \"quote\" : null, \"rating\" : 0.8, \"content\" : \"Second time we have eaten here. The Chicken lolipop appetizer is great, very tender and well cooked. The sous vide skirt steak was excellent, well seasoned and cooked to just the right temperature. Interior decor is pleasant and inviting. The BYOB concept is wonderful but don't bring a really great bottle of wine because the place does not have any real wine glasses. Wine is served in what is essentially a water glass with a very wide open top. This is something that they really should fix. Overall a very good experience, the food has not been disappointing at all. The Amish chicken is excellent and the whitefish dish I saw served to other tables looked really good. Will go back but may bring a wine glass.\", \"date\" : \"Date( 1585551600000 )\" }, { \"quote\" : null, \"rating\" : 0.6, \"content\" : \"Important and well-meaning concept: more affordable fine dining in the suburbs. Most dishes were good. Would put more a more generous helping of fish on those dishes.\", \"date\" : \"Date( 1585638000000 )\" }, { \"quote\" : null, \"rating\" : 0.8, \"content\" : \"You can't beat a place with their menu and prices with a free byob policy (they'll even open your wine) ... if you can't drink wine from a stubby martini glass, then bring your own glasses...I mean, you can walk in with a flask (or bottle) and shaker, ask for the ice and glasses, and make your own martini's, no charge (best to bring your own olives). And the servers are right there with the glasses, ice, whatever, when they first come to the table, and there's no rush if you want to sip your cocktail and have a \\\"minor\\\" - the fried pork belly was crisp and delicious; before ordering a \\\"substantial\\\" - sous vide lamb special and the cavatelli - both very good - though I should have asked for the lamb rarer\", \"date\" : \"Date( 1585638000000 )\" }, { \"quote\" : null, \"rating\" : 1, \"content\" : \"Great dishes - Great Chef Michael\", \"date\" : \"Date( 1584946800000 )\" }, { \"quote\" : null, \"rating\" : 1, \"content\" : \"I've been to this restaurant many times. I, and everyone I've been with, always love what we order. I haven't been disappointed yet! I highly recommend this restaurant.\", \"date\" : \"Date( 1584169200000 )\" }, { \"quote\" : null, \"rating\" : 1, \"content\" : \"such a great find in Highland Park. Will go there often\", \"date\" : \"Date( 1583823600000 )\" }, { \"quote\" : null, \"rating\" : 0.8, \"content\" : \"What a great addition to the Highland Park restaurant scene. The focus on locally sourced ingredients made for a very interesting menu even in the middle of winter. This was my first exposure to food cooked using the sous-vide method and I have to say that the chicken I had was fantastic. It was tender, juicy and throughly enjoyable. The appetizers were great. The decor was accented by very engaging art on the walls that contributed to a comfortable atmoshphere. It was a big plus for me that this is a BYOB establishment. My only complaint with what was otherwise an excellent experience would have to be the glasses provided for our wine. They do not provide true wine glasses, just wide mouth water glasses.\", \"date\" : \"Date( 1582099200000 )\" } ], \"rating\" : 0, \"food_rating\" : 0.82, \"atmosphere_rating\" : 0.6599999999999999, \"service_rating\" : 0.78, \"website\" : \"http://www.2ndstreetbistrohp.com\", \"cuisine\" : \"Contemporary American, American\", \"payment\" : \"AMEX, Discover, MasterCard, Visa\", \"features\" : \"BYO Liquor, Delivery, Farm to Table, Gluten-free Menu, Personal wines welcome, Takeout, Wheelchair Access\", \"hours\" : \"Dinner 5:00pm - 9:00pm, Tuesday, Wednesday, Thursday & Sunday\\r\\n 5:00pm - 10:00pm Friday & Saturday\", \"parking\" : \"\", \"desc\" : \"Second Street Bistro features upscale American food with a twist. Choose from an extensive selection of appetizers, main dishes and sides made with local and organic ingredients, whenever possible. Appetizer specialties, referred to as “Minors” on the menu, include dishes such as Shaved Organic… Brussels Sprout; Roasted Corn and Gulf Shrimp; Truffled Cauliflower Soup; and Braised Rapini. Among the entrees are Slow Cooked Beef Short Rib; Ocean Raised Scottish Salmon; Herb Marinated Amish Chicken; Gluten-Free Quinoa Spaghetti; and Marinated Skirt Steak. Sides such as Cinnamon Sugar Sweet Potato Fries and Roasted Locally Grown Vegetables are designed to enhance the distinct flavors on the menu. In-keeping with seasonal produce, executive chef, Michael Gottlieb, will also be introducing menu specials on a regular basis, ensuring that only the freshest and best ingredients are used. Second Street Bistro is the only BYOB restaurant in Highland Park, all adult beverages welcome, no corkage!!!Continued\", \"attire\" : \"Casual Dress\", \"dining_style\" : \"Casual Elegant\", \"price\" : \"$30 and under\", \"email\" : \"cheffmichael@yahoo.com\" }\n" +
                    "{ \"_id\" : \"4f91fd69c58a968724000003\", \"title\" : \"309\", \"source\" : null, \"source_id\" : \"http://www.opentable.com/309?scpref=106\", \"reviews\" : [ { \"quote\" : null, \"rating\" : 0.4, \"content\" : \"On a very slow Saturday evening (7:30 p.m.), very slow service. We were very dissappointed in the limited menu. Had heard from friends of the trout dinner, not even on the menu. No bread or rolls were offered, no cracked pepper offered on our brown trimmed wedge salad. Our waiter did not even come back to see if our entrees were fixed to our liking. My husbands steak ordered medium was really closeWriter to well done. We were with another couple, and we were very embarrassed by 309.\", \"date\" : \"Date( 1586847600000 )\" }, { \"quote\" : null, \"rating\" : 0.2, \"content\" : \"We were all disappointed (party of 7). The Easter Buffet was mediocre (at best). Many of the entres were empty. The shrimp was in water rather then ice. The general food quality was low. Pretty bland entries - not much flavor. I'll not be going back anytime soon. Too bad, I was impressed with the Sunday Brunch that the 309 had on two (much) earlier occations (I recommended 309 to our group for Easter and I was let down). It is sad to see a good restaurant make comprimises that can lead to their eventual demise. I'll not be going back till I hear that the quality has improved.\", \"date\" : \"Date( 1586329200000 )\" }, { \"quote\" : null, \"rating\" : 0.8, \"content\" : \"Lunch at 309 was a great experience. I have visited the restaurant several times and wasn't happy. I decided to give it another try and was happy with the experience. I would highly recommend it for lunch.\", \"date\" : \"Date( 1584687600000 )\" }, { \"quote\" : null, \"rating\" : 1, \"content\" : \"Had a family member home visiting and dinner was a great time to catch up over a nice meal. The food was delicious and the wine prices were the best I've seen in the area.\", \"date\" : \"Date( 1583737200000 )\" }, { \"quote\" : null, \"rating\" : 0.6, \"content\" : \"Food was very good but very small portions. The salad was very good. Dinners reminded me of small plates\", \"date\" : \"Date( 1583222400000 )\" }, { \"quote\" : null, \"rating\" : 1, \"content\" : \"nice romantic resturant,great food & atmosphere.entrees were pricey & for no veiw oroutdoor dining, would recommend.\", \"date\" : \"Date( 1581667200000 )\" }, { \"quote\" : null, \"rating\" : 0.8, \"content\" : \"Amazing restaurant, entrees were delicious, My husband and I had the Filet. The portions are fairly smaller than most places. We went for Valentines Day so I am not sure what their normal menu looks like, but I know they didn't have many options and I heard the lady beside us comment the same thing. And we didn't even order any appetizers because they only had a few options and none of them appealed to us. The red velvet cheesecake brownie was amazing. We will probably go back one more time to see if on a regular night they have a different menu then they had Valentine night. If it is the same, I can't see us going back again.\", \"date\" : \"Date( 1581667200000 )\" }, { \"quote\" : null, \"rating\" : 1, \"content\" : \"My fiance and I went to 309 for our Valentine's celebration. Every bite was delicious. We enjoyed calamari, steak, fantastic wine, and creme brulee. I would recommend this for a special night printStream!\", \"date\" : \"Date( 1581580800000 )\" }, { \"quote\" : null, \"rating\" : 0.6, \"content\" : \"Food was good could have been warmer, for the price I would have expected better. Service was good but they seemed understaffed for a busy Saturday night dinner so server and kitchen service seemed slow. Stayed after dinner in the bar area and had a good time with friends. Would go back to the bar again for drinks but not sure if the value is there for dinner again.\", \"date\" : \"Date( 1581408000000 )\" }, { \"quote\" : null, \"rating\" : 0.4, \"content\" : \"Food was too expensive for what I received. It just seemed ordinary. I would prefer to go to Biaggis or Bastas. The service was a little sloppy as well.\", \"date\" : \"Date( 1580803200000 )\" } ], \"rating\" : 0, \"food_rating\" : 0.76, \"atmosphere_rating\" : 0.78, \"service_rating\" : 0.72, \"website\" : \"http://www.309peoria.com\", \"cuisine\" : \"Contemporary American, Steak\", \"payment\" : \"AMEX, MasterCard, Visa\", \"features\" : \"Banquet/Private Rooms, Bar Dining, Beer, Fireplace, Happy Hour, Non-Smoking Restaurant, Personal wines welcome (corkage fee applies), Takeout, Weekend Brunch, Wheelchair Access, Wine\", \"hours\" : \"Monday -Thursday 11am-9pm \\r\\nFriday 11am-11pm \\r\\nSaturday 4pm-11pm \\r\\nSunday Brunch 10:30-2pm\", \"parking\" : \"\", \"desc\" : \"3o9 brings a new and exciting concept of Contemporary American dining to the Peoria area. The restaurant provides a vibrant atmosphere, along with a menu that is sure to please all palates. The menu features bites and small plates for sharing, savory grilled steaks, fresh seafood and delicious… sandwiches, burgers, salads and pastas. Family style dining and children’s menu are available as well. Dining in the Mid Tempo Lounge is also a great experience; enjoy the double-sided fireplace, beautiful bar and cozy decor. Watch any event on plasma screens throughout the lounge or unwind listening to the great music playlist. 3o9 proudly serves handcrafted cocktails, seasonal beers, martinis and an abundant wine selection. Three well-appointed private dining facilities are available; each room includes a 55” state of the art flat screen TV. With extraordinary food, unique atmosphere, savvy cocktails, and reasonable prices, there are so many reasons to DINE, LOUNGE and GATHER with 3o9! Continued\", \"attire\" : \"Casual Dress\", \"dining_style\" : \"Casual Dining\", \"price\" : \"$30 and under\", \"email\" : \"309@309peoria.com\" }\n";

    private static final String[] categories = {
            "Contemporary American",
            "Contemporary American",
            "Contemporary American"
    };

    private static final Id[] ids = {
            new Id("4f91fd68c58a968724000001"),
            new Id("4f91fd68c58a968724000002"),
            new Id("4f91fd69c58a968724000003")
    };

    private static final String[] descs = {
            "Chef Omar Rodriguez have created a space that is warm, simple and modern. They have created a space not to distract from Rodriguez\"s fusion of seasonal ingredients and global creations.\r\nLiving his passion for food and working in some of Chicago's finest kitchens, Chef Rodriguez is meeting his… patrons' expectations for excellent cuisine. He continues to please with creativity and passion.\r\nJoin him for Chicago's only BYOB Chef's Table, where Chef Rodriguez will personally serve every course.\r\n\r\n\r\n\r\n\r\n(K)new does not require that infants or small children are included in party size for online reservations. Continued",
            "Second Street Bistro features upscale American food with a twist. Choose from an extensive selection of appetizers, main dishes and sides made with local and organic ingredients, whenever possible. Appetizer specialties, referred to as “Minors” on the menu, include dishes such as Shaved Organic… Brussels Sprout; Roasted Corn and Gulf Shrimp; Truffled Cauliflower Soup; and Braised Rapini. Among the entrees are Slow Cooked Beef Short Rib; Ocean Raised Scottish Salmon; Herb Marinated Amish Chicken; Gluten-Free Quinoa Spaghetti; and Marinated Skirt Steak. Sides such as Cinnamon Sugar Sweet Potato Fries and Roasted Locally Grown Vegetables are designed to enhance the distinct flavors on the menu. In-keeping with seasonal produce, executive chef, Michael Gottlieb, will also be introducing menu specials on a regular basis, ensuring that only the freshest and best ingredients are used. Second Street Bistro is the only BYOB restaurant in Highland Park, all adult beverages welcome, no corkage!!!Continued",
            "3o9 brings a new and exciting concept of Contemporary American dining to the Peoria area. The restaurant provides a vibrant atmosphere, along with a menu that is sure to please all palates. The menu features bites and small plates for sharing, savory grilled steaks, fresh seafood and delicious… sandwiches, burgers, salads and pastas. Family style dining and children’s menu are available as well. Dining in the Mid Tempo Lounge is also a great experience; enjoy the double-sided fireplace, beautiful bar and cozy decor. Watch any event on plasma screens throughout the lounge or unwind listening to the great music playlist. 3o9 proudly serves handcrafted cocktails, seasonal beers, martinis and an abundant wine selection. Three well-appointed private dining facilities are available; each room includes a 55” state of the art flat screen TV. With extraordinary food, unique atmosphere, savvy cocktails, and reasonable prices, there are so many reasons to DINE, LOUNGE and GATHER with 3o9! Continued"
    };

    @Test
    public void testReader() throws Exception {
        CollectionParameters cp = new CollectionParameters();
        cp.set(CollectionParameters.LABEL_FIELD, "cuisine");
        cp.set(CollectionParameters.TEXT_FIELD, "desc");
        cp.set(CollectionParameters.ID_FIELD, "_id");

        cp.set(CollectionParameters.FILE_NAME, IoUtil.createTempFile(json));

        CollectionReader reader = new JsonCategorizedTextReader();
        reader.initialize(cp);
        assertEquals(3, reader.getSize());
        int i = 0;
        for (Analyzable a : reader) {
            CategorizedTextContent ctc = (CategorizedTextContent) a;
            assertTrue(ctc.hasCategory(categories[i]));
            assertEquals(ids[i], ctc.getId());
            assertEquals(descs[i++], ctc.getText());
        }
    }
}
